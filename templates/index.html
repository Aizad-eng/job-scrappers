<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Scraper v2.0 - Config-Driven</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/cronstrue@2.26.0/dist/cronstrue.min.js"></script>
    <style>
        .loading { opacity: 0.5; pointer-events: none; }
        .status-completed { color: #10b981; }
        .status-failed { color: #ef4444; }
        .status-running { color: #f59e0b; }
        .modal-backdrop { background: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Job Scraper v2.0</h1>
            <p class="text-gray-600 mt-2">Config-driven scraping. Add new actors via config, not code.</p>
        </div>

        <!-- Create New Search -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Create New Job Search</h2>
            
            <form id="createForm" class="space-y-4">
                <!-- Basic Info Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Search Name *</label>
                        <input type="text" name="name" required
                               class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500"
                               placeholder="My Job Search">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Actor/Platform *</label>
                        <select name="actor_key" id="actorSelect" required
                                class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="">Select an actor...</option>
                            {% for actor in actors %}
                            <option value="{{ actor.actor_key }}" 
                                    data-schema='{{ actor.input_schema | tojson }}'
                                    data-filters='{{ actor.filter_config | tojson }}'>
                                {{ actor.display_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Schedule</label>
                        <select name="cron_schedule" class="w-full border rounded-md px-3 py-2">
                            <option value="0 */6 * * *">Every 6 hours</option>
                            <option value="0 */12 * * *">Every 12 hours</option>
                            <option value="0 9 * * *">Daily at 9 AM</option>
                            <option value="0 9 * * 1-5">Weekdays at 9 AM</option>
                            <option value="0 9 * * 1">Weekly on Monday</option>
                        </select>
                    </div>
                </div>

                <!-- Dynamic Actor Inputs -->
                <div id="actorInputs" class="border rounded-md p-4 bg-gray-50">
                    <p class="text-gray-500 text-sm">Select an actor to see its input fields</p>
                </div>

                <!-- Filter Rules -->
                <div id="filterRules" class="border rounded-md p-4 bg-gray-50 hidden">
                    <h3 class="font-medium text-gray-700 mb-3">Filter Rules</h3>
                    <div id="filterInputs" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
                </div>

                <!-- Output Configuration -->
                <div class="border rounded-md p-4 bg-gray-50">
                    <h3 class="font-medium text-gray-700 mb-3">Output Configuration</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Clay Webhook URL *</label>
                            <input type="url" name="clay_webhook_url" required
                                   class="w-full border rounded-md px-3 py-2"
                                   placeholder="https://api.clay.com/v1/webhooks/...">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Batch Size</label>
                                <input type="number" name="batch_size" value="8" min="1" max="50"
                                       class="w-full border rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Interval (ms)</label>
                                <input type="number" name="batch_interval_ms" value="2000" min="100"
                                       class="w-full border rounded-md px-3 py-2">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit -->
                <div class="flex justify-end gap-3">
                    <button type="submit" 
                            class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition">
                        Create Job Search
                    </button>
                </div>
            </form>
        </div>

        <!-- Existing Searches -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Job Searches</h2>
            
            <div class="overflow-x-auto">
                <table class="w-full" id="searchesTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Name</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Platform</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Schedule</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Next Run</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Last Run</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        {% for search in searches %}
                        <tr class="hover:bg-gray-50" data-id="{{ search.id }}">
                            <td class="px-4 py-3">
                                <span class="font-medium">{{ search.name }}</span>
                                {% if not search.is_active %}
                                <span class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded">Inactive</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-600">{{ search.actor_display_name or search.actor_key }}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">
                                <span class="cron-human" data-cron="{{ search.cron_schedule }}">{{ search.cron_schedule }}</span>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-600">
                                {% if search.is_active %}
                                <span class="next-run text-blue-600" data-cron="{{ search.cron_schedule }}">Calculating...</span>
                                {% else %}
                                <span class="text-gray-400">Paused</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-600">
                                {{ search.last_run_at.strftime('%Y-%m-%d %H:%M') if search.last_run_at else 'Never' }}
                            </td>
                            <td class="px-4 py-3">
                                <span class="status-{{ search.last_status or 'none' }} text-sm">
                                    {{ search.last_status or '-' }}
                                </span>
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex gap-2">
                                    <button onclick="runSearch({{ search.id }})" 
                                            class="text-green-600 hover:text-green-800 text-sm font-medium">
                                        Run
                                    </button>
                                    <button onclick="editSearch({{ search.id }})"
                                            class="text-yellow-600 hover:text-yellow-800 text-sm font-medium">
                                        Edit
                                    </button>
                                    <button onclick="viewRuns({{ search.id }})"
                                            class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                        History
                                    </button>
                                    <button onclick="duplicateSearch({{ search.id }})"
                                            class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                                        Duplicate
                                    </button>
                                    <button onclick="deleteSearch({{ search.id }}, '{{ search.name }}')"
                                            class="text-red-600 hover:text-red-800 text-sm font-medium">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                No job searches yet. Create one above!
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Run History Modal -->
        <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Run History</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">&times;</button>
                </div>
                <div id="historyContent" class="p-4 overflow-y-auto max-h-[60vh]">
                    Loading...
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Edit Job Search</h3>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div id="editContent" class="p-4 overflow-y-auto max-h-[70vh]">
                    <form id="editForm" class="space-y-4">
                        <input type="hidden" name="id" id="editId">
                        
                        <!-- Basic Info -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Search Name *</label>
                                <input type="text" name="name" id="editName" required
                                       class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Schedule</label>
                                <select name="cron_schedule" id="editCronSchedule" class="w-full border rounded-md px-3 py-2">
                                    <option value="0 */6 * * *">Every 6 hours</option>
                                    <option value="0 */12 * * *">Every 12 hours</option>
                                    <option value="0 9 * * *">Daily at 9 AM</option>
                                    <option value="0 9 * * 1-5">Weekdays at 9 AM</option>
                                    <option value="0 9 * * 1">Weekly on Monday</option>
                                </select>
                            </div>
                        </div>

                        <!-- Actor Info (Read-only) -->
                        <div class="bg-gray-50 p-3 rounded-md">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Platform</label>
                            <p id="editActorDisplay" class="text-gray-600"></p>
                            <input type="hidden" id="editActorKey">
                        </div>

                        <!-- Dynamic Actor Inputs -->
                        <div id="editActorInputs" class="border rounded-md p-4 bg-gray-50">
                            <h3 class="font-medium text-gray-700 mb-3">Actor Inputs</h3>
                            <div id="editActorInputsFields" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </div>

                        <!-- Filter Rules -->
                        <div id="editFilterRules" class="border rounded-md p-4 bg-gray-50">
                            <h3 class="font-medium text-gray-700 mb-3">Filter Rules</h3>
                            <div id="editFilterInputs" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </div>

                        <!-- Output Configuration -->
                        <div class="border rounded-md p-4 bg-gray-50">
                            <h3 class="font-medium text-gray-700 mb-3">Output Configuration</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Clay Webhook URL *</label>
                                    <input type="url" name="clay_webhook_url" id="editClayWebhook" required
                                           class="w-full border rounded-md px-3 py-2">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Batch Size</label>
                                        <input type="number" name="batch_size" id="editBatchSize" value="8" min="1" max="50"
                                               class="w-full border rounded-md px-3 py-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Interval (ms)</label>
                                        <input type="number" name="batch_interval_ms" id="editBatchInterval" value="2000" min="100"
                                               class="w-full border rounded-md px-3 py-2">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Active Toggle -->
                        <div class="flex items-center gap-2">
                            <input type="checkbox" name="is_active" id="editIsActive" class="h-4 w-4">
                            <label for="editIsActive" class="text-sm font-medium text-gray-700">Active (runs on schedule)</label>
                        </div>

                        <!-- Submit -->
                        <div class="flex justify-end gap-3 pt-4 border-t">
                            <button type="button" onclick="closeEditModal()"
                                    class="px-4 py-2 border rounded-md hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" 
                                    class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Store actor configs for edit modal
        const actorConfigs = {};
        {% for actor in actors %}
        actorConfigs['{{ actor.actor_key }}'] = {
            display_name: '{{ actor.display_name }}',
            input_schema: {{ actor.input_schema | tojson }},
            filter_config: {{ actor.filter_config | tojson }}
        };
        {% endfor %}

        // =================================================================
        // NEXT RUN CALCULATION
        // =================================================================
        
        function getNextCronRun(cronExpr) {
            // Simple cron parser for common patterns
            const parts = cronExpr.split(' ');
            if (parts.length !== 5) return 'Invalid';
            
            const [minute, hour, dayOfMonth, month, dayOfWeek] = parts;
            const now = new Date();
            let next = new Date(now);
            
            // Handle common patterns
            if (hour.startsWith('*/')) {
                // Every X hours
                const interval = parseInt(hour.substring(2));
                next.setMinutes(parseInt(minute) || 0);
                next.setSeconds(0);
                next.setMilliseconds(0);
                
                // Find next occurrence
                while (next <= now) {
                    next.setHours(next.getHours() + interval);
                }
            } else if (hour !== '*') {
                // Specific hour
                const targetHour = parseInt(hour);
                const targetMinute = parseInt(minute) || 0;
                
                next.setHours(targetHour, targetMinute, 0, 0);
                
                if (next <= now) {
                    next.setDate(next.getDate() + 1);
                }
                
                // Handle weekday restrictions
                if (dayOfWeek === '1-5') {
                    while (next.getDay() === 0 || next.getDay() === 6) {
                        next.setDate(next.getDate() + 1);
                    }
                } else if (dayOfWeek === '1') {
                    while (next.getDay() !== 1) {
                        next.setDate(next.getDate() + 1);
                    }
                }
            }
            
            return next.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: 'numeric', 
                minute: '2-digit'
            });
        }
        
        // Calculate next runs on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.next-run').forEach(el => {
                const cron = el.dataset.cron;
                el.textContent = getNextCronRun(cron);
            });
            
            // Convert cron to human readable
            document.querySelectorAll('.cron-human').forEach(el => {
                const cron = el.dataset.cron;
                try {
                    el.textContent = cronstrue.toString(cron);
                } catch (e) {
                    el.textContent = cron;
                }
            });
        });

        // =================================================================
        // DYNAMIC FORM GENERATION
        // =================================================================
        
        const actorSelect = document.getElementById('actorSelect');
        const actorInputs = document.getElementById('actorInputs');
        const filterRules = document.getElementById('filterRules');
        const filterInputs = document.getElementById('filterInputs');
        
        actorSelect.addEventListener('change', function() {
            const option = this.options[this.selectedIndex];
            
            if (!option.value) {
                actorInputs.innerHTML = '<p class="text-gray-500 text-sm">Select an actor to see its input fields</p>';
                filterRules.classList.add('hidden');
                return;
            }
            
            const schema = JSON.parse(option.dataset.schema || '[]');
            const filters = JSON.parse(option.dataset.filters || '{}');
            
            // Generate input fields
            actorInputs.innerHTML = '<h3 class="font-medium text-gray-700 mb-3">Actor Inputs</h3>' +
                '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' +
                schema.map(field => generateInputField(field, 'actor_')).join('') +
                '</div>';
            
            // Generate filter fields
            if (Object.keys(filters).length > 0) {
                filterRules.classList.remove('hidden');
                filterInputs.innerHTML = Object.entries(filters).map(([key, config]) => 
                    generateFilterField(key, config, 'filter_')
                ).join('');
            } else {
                filterRules.classList.add('hidden');
            }
        });
        
        function generateInputField(field, prefix = '', value = '') {
            const id = `${prefix}${field.name}`;
            const required = field.required ? 'required' : '';
            const placeholder = field.placeholder || '';
            const help = field.help ? `<p class="text-xs text-gray-500 mt-1">${field.help}</p>` : '';
            const defaultVal = value || field.default || '';
            
            let input = '';
            
            switch (field.type) {
                case 'textarea':
                    input = `<textarea name="${id}" ${required} rows="3"
                              class="w-full border rounded-md px-3 py-2 text-sm"
                              placeholder="${placeholder}">${defaultVal}</textarea>`;
                    break;
                    
                case 'select':
                    const options = (field.options || []).map(opt => 
                        `<option value="${opt.value}" ${opt.value === defaultVal ? 'selected' : ''}>${opt.label}</option>`
                    ).join('');
                    input = `<select name="${id}" ${required} class="w-full border rounded-md px-3 py-2">
                              ${options}
                            </select>`;
                    break;
                    
                case 'boolean':
                    const checked = defaultVal ? 'checked' : '';
                    input = `<input type="checkbox" name="${id}" ${checked} class="h-4 w-4">`;
                    break;
                    
                case 'number':
                    input = `<input type="number" name="${id}" value="${defaultVal}" ${required}
                              class="w-full border rounded-md px-3 py-2">`;
                    break;
                    
                default:  // text, url
                    input = `<input type="${field.type === 'url' ? 'url' : 'text'}" name="${id}" 
                              value="${defaultVal}" ${required}
                              class="w-full border rounded-md px-3 py-2"
                              placeholder="${placeholder}">`;
            }
            
            return `<div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    ${field.label} ${field.required ? '*' : ''}
                </label>
                ${input}
                ${help}
            </div>`;
        }
        
        function generateFilterField(key, config, prefix = '', value = '') {
            let label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            let placeholder = '';
            
            if (config.type === 'exclude_contains') {
                placeholder = 'Comma-separated values to exclude';
            } else if (config.type === 'min_value') {
                label = 'Min ' + label.replace('Min ', '');
            } else if (config.type === 'max_value') {
                label = 'Max ' + label.replace('Max ', '');
            }
            
            const inputType = config.type.includes('value') ? 'number' : 'text';
            
            return `<div>
                <label class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                <input type="${inputType}" name="${prefix}${key}" value="${value || ''}"
                       class="w-full border rounded-md px-3 py-2 text-sm"
                       placeholder="${placeholder}">
            </div>`;
        }
        
        // =================================================================
        // FORM SUBMISSION (CREATE)
        // =================================================================
        
        document.getElementById('createForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const actorKey = formData.get('actor_key');
            
            // Build actor_inputs from dynamic fields
            const actorInputsData = {};
            const filterRulesData = {};
            
            for (const [key, value] of formData.entries()) {
                if (key.startsWith('actor_') && value) {
                    const fieldName = key.replace('actor_', '');
                    actorInputsData[fieldName] = value;
                } else if (key.startsWith('filter_') && value) {
                    const fieldName = key.replace('filter_', '');
                    filterRulesData[fieldName] = value;
                }
            }
            
            const payload = {
                name: formData.get('name'),
                actor_key: actorKey,
                cron_schedule: formData.get('cron_schedule'),
                actor_inputs: actorInputsData,
                filter_rules: filterRulesData,
                clay_webhook_url: formData.get('clay_webhook_url'),
                batch_size: parseInt(formData.get('batch_size')) || 8,
                batch_interval_ms: parseInt(formData.get('batch_interval_ms')) || 2000
            };
            
            try {
                this.classList.add('loading');
                
                const response = await fetch('/api/searches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create search');
                }
                
                location.reload();
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                this.classList.remove('loading');
            }
        });
        
        // =================================================================
        // EDIT FUNCTIONALITY
        // =================================================================
        
        async function editSearch(id) {
            const modal = document.getElementById('editModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            try {
                const response = await fetch(`/api/searches/${id}`);
                const search = await response.json();
                
                // Populate basic fields
                document.getElementById('editId').value = search.id;
                document.getElementById('editName').value = search.name;
                document.getElementById('editCronSchedule').value = search.cron_schedule;
                document.getElementById('editClayWebhook').value = search.clay_webhook_url;
                document.getElementById('editBatchSize').value = search.batch_size;
                document.getElementById('editBatchInterval').value = search.batch_interval_ms;
                document.getElementById('editIsActive').checked = search.is_active;
                document.getElementById('editActorKey').value = search.actor_key;
                document.getElementById('editActorDisplay').textContent = search.actor_display_name || search.actor_key;
                
                // Get actor config
                const actorConfig = actorConfigs[search.actor_key];
                
                if (actorConfig) {
                    // Generate actor input fields with current values
                    const inputFields = actorConfig.input_schema.map(field => {
                        const value = search.actor_inputs[field.name] || '';
                        return generateInputField(field, 'edit_actor_', value);
                    }).join('');
                    document.getElementById('editActorInputsFields').innerHTML = inputFields;
                    
                    // Generate filter fields with current values
                    const filterFields = Object.entries(actorConfig.filter_config).map(([key, config]) => {
                        const value = search.filter_rules[key] || '';
                        return generateFilterField(key, config, 'edit_filter_', value);
                    }).join('');
                    document.getElementById('editFilterInputs').innerHTML = filterFields;
                }
                
            } catch (error) {
                alert('Error loading search: ' + error.message);
                closeEditModal();
            }
        }
        
        function closeEditModal() {
            const modal = document.getElementById('editModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('editId').value;
            const formData = new FormData(this);
            
            // Build actor_inputs and filter_rules from dynamic fields
            const actorInputsData = {};
            const filterRulesData = {};
            
            for (const [key, value] of formData.entries()) {
                if (key.startsWith('edit_actor_') && value) {
                    const fieldName = key.replace('edit_actor_', '');
                    actorInputsData[fieldName] = value;
                } else if (key.startsWith('edit_filter_') && value) {
                    const fieldName = key.replace('edit_filter_', '');
                    filterRulesData[fieldName] = value;
                }
            }
            
            const payload = {
                name: formData.get('name'),
                cron_schedule: formData.get('cron_schedule'),
                actor_inputs: actorInputsData,
                filter_rules: filterRulesData,
                clay_webhook_url: formData.get('clay_webhook_url'),
                batch_size: parseInt(formData.get('batch_size')) || 8,
                batch_interval_ms: parseInt(formData.get('batch_interval_ms')) || 2000,
                is_active: formData.get('is_active') === 'on'
            };
            
            try {
                this.classList.add('loading');
                
                const response = await fetch(`/api/searches/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to update search');
                }
                
                location.reload();
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                this.classList.remove('loading');
            }
        });
        
        // =================================================================
        // OTHER ACTIONS
        // =================================================================
        
        async function runSearch(id) {
            if (!confirm('Run this search now?')) return;
            
            try {
                const response = await fetch(`/api/searches/${id}/execute`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Success! Found: ${result.jobs_found}, Filtered: ${result.jobs_filtered}, Sent: ${result.jobs_sent}`);
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function viewRuns(id) {
            const modal = document.getElementById('historyModal');
            const content = document.getElementById('historyContent');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            content.innerHTML = 'Loading...';
            
            try {
                const response = await fetch(`/api/searches/${id}/runs?limit=20`);
                const runs = await response.json();
                
                if (runs.length === 0) {
                    content.innerHTML = '<p class="text-gray-500">No runs yet</p>';
                    return;
                }
                
                content.innerHTML = `
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-sm">Started</th>
                                <th class="px-3 py-2 text-left text-sm">Status</th>
                                <th class="px-3 py-2 text-left text-sm">Found</th>
                                <th class="px-3 py-2 text-left text-sm">Filtered</th>
                                <th class="px-3 py-2 text-left text-sm">Sent</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${runs.map(run => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 text-sm">${new Date(run.started_at).toLocaleString()}</td>
                                    <td class="px-3 py-2 text-sm status-${run.status}">${run.status}</td>
                                    <td class="px-3 py-2 text-sm">${run.jobs_found}</td>
                                    <td class="px-3 py-2 text-sm">${run.jobs_filtered}</td>
                                    <td class="px-3 py-2 text-sm">${run.jobs_sent}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                content.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }
        
        function closeModal() {
            const modal = document.getElementById('historyModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        async function duplicateSearch(id) {
            try {
                const response = await fetch(`/api/searches/${id}/duplicate`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function deleteSearch(id, name) {
            if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
            
            try {
                const response = await fetch(`/api/searches/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        // Close modals on escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeEditModal();
            }
        });
    </script>
</body>
</html>
