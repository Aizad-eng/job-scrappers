<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Scraper v2.0 - Config-Driven</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/cronstrue@2.26.0/dist/cronstrue.min.js"></script>
    <style>
        .loading { opacity: 0.5; pointer-events: none; }
        .status-completed { color: #10b981; }
        .status-failed { color: #ef4444; }
        .status-running { color: #f59e0b; }
        .modal-backdrop { background: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Job Scraper v2.0</h1>
                <p class="text-gray-600 mt-2">Config-driven scraping. Add new actors via config, not code.</p>
            </div>
            <div class="flex gap-3">
                <a href="/analytics" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Analytics
                </a>
            </div>
        </div>

        <!-- Create New Search -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Create New Job Search</h2>
            
            <form id="createForm" class="space-y-4">
                <!-- Basic Info Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Search Name *</label>
                        <input type="text" name="name" required
                               class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500"
                               placeholder="My Job Search">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Actor/Platform *</label>
                        <select name="actor_key" id="actorSelect" required
                                class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="">Select an actor...</option>
                            {% for actor in actors %}
                            <option value="{{ actor.actor_key }}" 
                                    data-schema='{{ actor.input_schema | tojson }}'
                                    data-filters='{{ actor.filter_config | tojson }}'
                                    data-schedule-type='{{ actor.schedule_type }}'>
                                {{ actor.display_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Schedule section - hidden until actor is selected -->
                    <div id="scheduleContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Schedule (EST)</label>
                        
                        <!-- Unified time-based scheduling for all actors -->
                        <div id="timeSchedule">
                            <div class="space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <select name="frequency" id="frequencySelect" class="border rounded-md px-3 py-2">
                                        <option value="daily">Every day</option>
                                        <option value="weekdays">Weekdays only</option>
                                        <option value="weekly">Weekly</option>
                                    </select>
                                    <input type="time" name="time" id="timeInput" value="09:00" 
                                           class="border rounded-md px-3 py-2">
                                </div>
                                
                                <!-- Day selector for weekly -->
                                <div id="weeklyDaySelect" class="hidden">
                                    <label class="block text-sm text-gray-600 mb-1">Select day of week:</label>
                                    <select name="weekly_day" id="weeklyDayInput" class="w-full border rounded-md px-3 py-2">
                                        <option value="1">Monday</option>
                                        <option value="2">Tuesday</option>
                                        <option value="3">Wednesday</option>
                                        <option value="4">Thursday</option>
                                        <option value="5">Friday</option>
                                        <option value="6">Saturday</option>
                                        <option value="0">Sunday</option>
                                    </select>
                                </div>
                                
                                <p id="schedulePreview" class="text-xs text-gray-500"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Actor Inputs -->
                <div id="actorInputs" class="border rounded-md p-4 bg-gray-50">
                    <p class="text-gray-500 text-sm">Select an actor to see its input fields</p>
                </div>

                <!-- Filter Rules -->
                <div id="filterRules" class="border rounded-md p-4 bg-gray-50 hidden">
                    <h3 class="font-medium text-gray-700 mb-3">Filter Rules</h3>
                    <div id="filterInputs" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
                </div>

                <!-- Output Configuration -->
                <div class="border rounded-md p-4 bg-gray-50">
                    <h3 class="font-medium text-gray-700 mb-3">Output Configuration</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Clay Webhook URL *</label>
                            <input type="url" name="clay_webhook_url" required
                                   class="w-full border rounded-md px-3 py-2"
                                   placeholder="https://api.clay.com/v1/webhooks/...">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Batch Size</label>
                                <input type="number" name="batch_size" value="8" min="1" max="50"
                                       class="w-full border rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Interval (ms)</label>
                                <input type="number" name="batch_interval_ms" value="2000" min="100"
                                       class="w-full border rounded-md px-3 py-2">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit -->
                <div class="flex justify-end gap-3">
                    <button type="submit" 
                            class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition">
                        Create Job Search
                    </button>
                </div>
            </form>
        </div>

        <!-- Existing Searches -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Job Searches</h2>
            
            <div class="overflow-x-auto">
                <table class="w-full" id="searchesTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Name</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Platform</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Schedule</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Next Run (EST)</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Last Run</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        {% for search in searches %}
                        <tr class="hover:bg-gray-50" data-id="{{ search.id }}">
                            <td class="px-4 py-3">
                                <span class="font-medium">{{ search.name }}</span>
                                {% if not search.is_active %}
                                <span class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded">Inactive</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-600">{{ search.actor_display_name or search.actor_key }}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">
                                <span class="cron-human" data-cron="{{ search.cron_schedule }}">{{ search.cron_schedule }}</span>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-600">
                                {% if search.is_active and search.next_run_time %}
                                <span class="text-blue-600">{{ search.next_run_time.strftime('%b %d, %I:%M %p') }} EST</span>
                                {% elif search.is_active %}
                                <span class="text-orange-600">Loading...</span>
                                {% else %}
                                <span class="text-gray-400">Paused</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-600">
                                {{ search.last_run_at.strftime('%Y-%m-%d %H:%M') if search.last_run_at else 'Never' }}
                            </td>
                            <td class="px-4 py-3">
                                <span class="status-{{ search.last_status or 'none' }} text-sm">
                                    {{ search.last_status or '-' }}
                                </span>
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex gap-2">
                                    <button onclick="runSearch({{ search.id }})" 
                                            class="text-green-600 hover:text-green-800 text-sm font-medium">
                                        Run
                                    </button>
                                    <button onclick="viewSearchDetails({{ search.id }})"
                                            class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                        View
                                    </button>
                                    <button onclick="editSearch({{ search.id }})"
                                            class="text-yellow-600 hover:text-yellow-800 text-sm font-medium">
                                        Edit
                                    </button>
                                    <button onclick="viewRuns({{ search.id }})"
                                            class="text-gray-600 hover:text-gray-800 text-sm font-medium">
                                        History
                                    </button>
                                    <button onclick="duplicateSearch({{ search.id }})"
                                            class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                                        Duplicate
                                    </button>
                                    <button onclick="deleteSearch({{ search.id }}, '{{ search.name }}')"
                                            class="text-red-600 hover:text-red-800 text-sm font-medium">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                No job searches yet. Create one above!
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Run History Modal -->
        <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Run History</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">&times;</button>
                </div>
                <div id="historyContent" class="p-4 overflow-y-auto max-h-[60vh]">
                    Loading...
                </div>
            </div>
        </div>

        <!-- Logs Modal -->
        <div id="logsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Execution Logs</h3>
                    <button onclick="closeLogsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div id="logsContent" class="p-4 overflow-y-auto max-h-[75vh] bg-gray-900 text-gray-100 font-mono text-sm whitespace-pre-wrap">
                    Loading...
                </div>
            </div>
        </div>

        <!-- Quick View Modal -->
        <div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Job Search Details</h3>
                    <button onclick="closeDetailsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div id="detailsContent" class="p-6 overflow-y-auto max-h-[60vh]">
                    <div class="space-y-6">
                        <!-- Basic Info -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="text-lg font-medium text-gray-800 mb-3">Basic Information</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><span class="font-medium">Name:</span> <span id="detail-name"></span></div>
                                <div><span class="font-medium">Platform:</span> <span id="detail-platform"></span></div>
                                <div><span class="font-medium">Schedule:</span> <span id="detail-schedule"></span></div>
                                <div><span class="font-medium">Status:</span> <span id="detail-status"></span></div>
                            </div>
                        </div>
                        
                        <!-- Actor Inputs -->
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h4 class="text-lg font-medium text-gray-800 mb-3">Search Configuration</h4>
                            <div id="detail-inputs" class="grid grid-cols-1 gap-3 text-sm"></div>
                        </div>
                        
                        <!-- Filter Rules -->
                        <div class="bg-yellow-50 rounded-lg p-4">
                            <h4 class="text-lg font-medium text-gray-800 mb-3">Filter Rules</h4>
                            <div id="detail-filters" class="grid grid-cols-1 gap-3 text-sm"></div>
                        </div>
                        
                        <!-- Output Configuration -->
                        <div class="bg-green-50 rounded-lg p-4">
                            <h4 class="text-lg font-medium text-gray-800 mb-3">Output Configuration</h4>
                            <div class="space-y-2 text-sm">
                                <div><span class="font-medium">Clay Webhook:</span> <span id="detail-webhook" class="break-all text-blue-600"></span></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><span class="font-medium">Batch Size:</span> <span id="detail-batch-size"></span></div>
                                    <div><span class="font-medium">Batch Interval:</span> <span id="detail-batch-interval"></span>ms</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Edit Job Search</h3>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div id="editContent" class="p-4 overflow-y-auto max-h-[70vh]">
                    <form id="editForm" class="space-y-4">
                        <input type="hidden" name="id" id="editId">
                        
                        <!-- Basic Info -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Search Name *</label>
                                <input type="text" name="name" id="editName" required
                                       class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Schedule (EST)</label>
                                <div class="space-y-3">
                                    <div class="grid grid-cols-2 gap-2">
                                        <select name="frequency" id="editFrequencySelect" class="border rounded-md px-3 py-2">
                                            <option value="daily">Every day</option>
                                            <option value="weekdays">Weekdays only</option>
                                            <option value="weekly">Weekly</option>
                                        </select>
                                        <input type="time" name="time" id="editTimeInput" value="09:00" 
                                               class="border rounded-md px-3 py-2">
                                    </div>
                                    
                                    <!-- Day selector for weekly -->
                                    <div id="editWeeklyDaySelect" class="hidden">
                                        <label class="block text-sm text-gray-600 mb-1">Select day of week:</label>
                                        <select name="weekly_day" id="editWeeklyDayInput" class="w-full border rounded-md px-3 py-2">
                                            <option value="1">Monday</option>
                                            <option value="2">Tuesday</option>
                                            <option value="3">Wednesday</option>
                                            <option value="4">Thursday</option>
                                            <option value="5">Friday</option>
                                            <option value="6">Saturday</option>
                                            <option value="0">Sunday</option>
                                        </select>
                                    </div>
                                    
                                    <p id="editSchedulePreview" class="text-xs text-gray-500"></p>
                                </div>
                                <input type="hidden" name="cron_schedule" id="editCronSchedule">
                            </div>
                        </div>

                        <!-- Actor Info (Read-only) -->
                        <div class="bg-gray-50 p-3 rounded-md">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Platform</label>
                            <p id="editActorDisplay" class="text-gray-600"></p>
                            <input type="hidden" id="editActorKey">
                        </div>

                        <!-- Dynamic Actor Inputs -->
                        <div id="editActorInputs" class="border rounded-md p-4 bg-gray-50">
                            <h3 class="font-medium text-gray-700 mb-3">Actor Inputs</h3>
                            <div id="editActorInputsFields" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </div>

                        <!-- Filter Rules -->
                        <div id="editFilterRules" class="border rounded-md p-4 bg-gray-50">
                            <h3 class="font-medium text-gray-700 mb-3">Filter Rules</h3>
                            <div id="editFilterInputs" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </div>

                        <!-- Output Configuration -->
                        <div class="border rounded-md p-4 bg-gray-50">
                            <h3 class="font-medium text-gray-700 mb-3">Output Configuration</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Clay Webhook URL *</label>
                                    <input type="url" name="clay_webhook_url" id="editClayWebhook" required
                                           class="w-full border rounded-md px-3 py-2">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Batch Size</label>
                                        <input type="number" name="batch_size" id="editBatchSize" value="8" min="1" max="50"
                                               class="w-full border rounded-md px-3 py-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Interval (ms)</label>
                                        <input type="number" name="batch_interval_ms" id="editBatchInterval" value="2000" min="100"
                                               class="w-full border rounded-md px-3 py-2">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Active Toggle -->
                        <div class="flex items-center gap-2">
                            <input type="checkbox" name="is_active" id="editIsActive" class="h-4 w-4">
                            <label for="editIsActive" class="text-sm font-medium text-gray-700">Active (runs on schedule)</label>
                        </div>

                        <!-- Submit -->
                        <div class="flex justify-end gap-3 pt-4 border-t">
                            <button type="button" onclick="closeEditModal()"
                                    class="px-4 py-2 border rounded-md hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" 
                                    class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Store actor configs for edit modal
        const actorConfigs = {};
        {% for actor in actors %}
        actorConfigs['{{ actor.actor_key }}'] = {
            display_name: '{{ actor.display_name }}',
            input_schema: {{ actor.input_schema | tojson }},
            filter_config: {{ actor.filter_config | tojson }},
            schedule_type: '{{ actor.schedule_type }}'
        };
        {% endfor %}

        // =================================================================
        // DEBUG: Test JavaScript functionality
        // =================================================================
        console.log('üöÄ JavaScript loaded successfully');
        
        window.addEventListener('load', function() {
            console.log('üì± Page loaded, checking functions...');
            console.log('runSearch function:', typeof runSearch);
            console.log('viewSearchDetails function:', typeof viewSearchDetails); 
            console.log('editSearch function:', typeof editSearch);
            console.log('viewRuns function:', typeof viewRuns);
        });

        // =================================================================
        // SCHEDULE BUILDER (EST TIMEZONE)
        // =================================================================
        
        const EST_TIMEZONE = 'America/New_York';
        
        const scheduleContainer = document.getElementById('scheduleContainer');
        const timeSchedule = document.getElementById('timeSchedule');
        const frequencySelect = document.getElementById('frequencySelect');
        const weeklyDaySelect = document.getElementById('weeklyDaySelect');
        const schedulePreview = document.getElementById('schedulePreview');
        const timeInput = document.getElementById('timeInput');
        const weeklyDayInput = document.getElementById('weeklyDayInput');
        
        function showScheduleForActor(actorKey) {
            // Hide schedule container if no actor selected
            if (!actorKey) {
                scheduleContainer.classList.add('hidden');
                return;
            }
            
            // Show schedule container with unified time-based scheduling
            scheduleContainer.classList.remove('hidden');
            updateTimeSchedulePreview();
        }
        
        function updateTimeScheduleOptions() {
            const freq = frequencySelect.value;
            
            if (freq === 'weekly') {
                weeklyDaySelect.classList.remove('hidden');
            } else {
                weeklyDaySelect.classList.add('hidden');
            }
            
            updateTimeSchedulePreview();
        }
        
        function buildTimeBasedCron() {
            const time = timeInput.value.split(':');
            const hour = parseInt(time[0]);
            const minute = parseInt(time[1]);
            const freq = frequencySelect.value;
            
            switch (freq) {
                case 'daily':
                    return `${minute} ${hour} * * *`;
                
                case 'weekdays':
                    return `${minute} ${hour} * * 1-5`;
                
                case 'weekly':
                    const day = weeklyDayInput.value;
                    return `${minute} ${hour} * * ${day}`;
                
                default:
                    return `${minute} ${hour} * * *`;
            }
        }
        
        function updateTimeSchedulePreview() {
            if (!schedulePreview) return;
            
            const cron = buildTimeBasedCron();
            try {
                schedulePreview.textContent = cronstrue.toString(cron);
            } catch (e) {
                schedulePreview.textContent = cron;
            }
        }
        
        // Event listeners for time-based schedule
        if (frequencySelect) {
            frequencySelect.addEventListener('change', updateTimeScheduleOptions);
        }
        if (timeInput) {
            timeInput.addEventListener('change', updateTimeSchedulePreview);
        }
        if (weeklyDayInput) {
            weeklyDayInput.addEventListener('change', updateTimeSchedulePreview);
        }

        // =================================================================
        // EDIT MODAL SCHEDULE FUNCTIONS  
        // =================================================================
        
        function setupEditScheduleListeners() {
            const editFrequencySelect = document.getElementById('editFrequencySelect');
            const editTimeInput = document.getElementById('editTimeInput');
            const editWeeklyDayInput = document.getElementById('editWeeklyDayInput');
            
            if (editFrequencySelect) {
                editFrequencySelect.addEventListener('change', updateEditTimeScheduleOptions);
            }
            if (editTimeInput) {
                editTimeInput.addEventListener('change', updateEditTimeSchedulePreview);
            }
            if (editWeeklyDayInput) {
                editWeeklyDayInput.addEventListener('change', updateEditTimeSchedulePreview);
            }
        }

        function updateEditTimeScheduleOptions() {
            const editFrequencySelect = document.getElementById('editFrequencySelect');
            const editWeeklyDaySelect = document.getElementById('editWeeklyDaySelect');
            
            const freq = editFrequencySelect.value;
            
            if (freq === 'weekly') {
                editWeeklyDaySelect.classList.remove('hidden');
            } else {
                editWeeklyDaySelect.classList.add('hidden');
            }
            
            updateEditTimeSchedulePreview();
        }

        function updateEditTimeSchedulePreview() {
            const editSchedulePreview = document.getElementById('editSchedulePreview');
            const editCronSchedule = document.getElementById('editCronSchedule');
            
            if (!editSchedulePreview) return;
            
            const cron = buildEditTimeBasedCron();
            editCronSchedule.value = cron;
            
            try {
                editSchedulePreview.textContent = cronstrue.toString(cron);
            } catch (e) {
                editSchedulePreview.textContent = cron;
            }
        }

        function buildEditTimeBasedCron() {
            const editTimeInput = document.getElementById('editTimeInput');
            const editFrequencySelect = document.getElementById('editFrequencySelect');
            const editWeeklyDayInput = document.getElementById('editWeeklyDayInput');
            
            const time = editTimeInput.value.split(':');
            const hour = parseInt(time[0]);
            const minute = parseInt(time[1]);
            const freq = editFrequencySelect.value;
            
            switch (freq) {
                case 'daily':
                    return `${minute} ${hour} * * *`;
                
                case 'weekdays':
                    return `${minute} ${hour} * * 1-5`;
                
                case 'weekly':
                    const day = editWeeklyDayInput.value;
                    return `${minute} ${hour} * * ${day}`;
                
                default:
                    return `${minute} ${hour} * * *`;
            }
        }

        function populateEditScheduleFromCron(cron) {
            const editFrequencySelect = document.getElementById('editFrequencySelect');
            const editTimeInput = document.getElementById('editTimeInput');
            const editWeeklyDayInput = document.getElementById('editWeeklyDayInput');
            const editCronSchedule = document.getElementById('editCronSchedule');
            const editWeeklyDaySelect = document.getElementById('editWeeklyDaySelect');
            
            // Set hidden cron field
            editCronSchedule.value = cron;
            
            // Parse cron: minute hour day month weekday
            const parts = cron.split(' ');
            if (parts.length !== 5) return;
            
            const [minute, hour, day, month, weekday] = parts;
            
            // Set time
            const h = hour.padStart(2, '0');
            const m = minute.padStart(2, '0');
            editTimeInput.value = `${h}:${m}`;
            
            // Determine frequency and set selects
            if (weekday === '1-5') {
                // Weekdays
                editFrequencySelect.value = 'weekdays';
                editWeeklyDaySelect.classList.add('hidden');
            } else if (weekday !== '*') {
                // Specific day (weekly)
                editFrequencySelect.value = 'weekly';
                editWeeklyDayInput.value = weekday;
                editWeeklyDaySelect.classList.remove('hidden');
            } else {
                // Daily
                editFrequencySelect.value = 'daily';
                editWeeklyDaySelect.classList.add('hidden');
            }
            
            // Update preview
            updateEditTimeSchedulePreview();
        }

        // =================================================================
        // NEXT RUN CALCULATION
        // =================================================================
        
        // Convert cron to human readable on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.cron-human').forEach(el => {
                const cron = el.dataset.cron;
                try {
                    el.textContent = cronstrue.toString(cron);
                } catch (e) {
                    el.textContent = cron;
                }
            });
        });

        // =================================================================
        // DYNAMIC FORM GENERATION
        // =================================================================
        
        // Wait for DOM to be ready before setting up form handlers
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Setting up form handlers...');
            
            const actorSelect = document.getElementById('actorSelect');
            const actorInputs = document.getElementById('actorInputs');
            const filterRules = document.getElementById('filterRules');
            const filterInputs = document.getElementById('filterInputs');
            
            console.log('Actor select element:', actorSelect);
            console.log('Actor inputs element:', actorInputs);
            
            if (!actorSelect || !actorInputs) {
                console.error('‚ùå Required form elements not found!');
                return;
            }
            
            actorSelect.addEventListener('change', function() {
                console.log('üéØ Actor selection changed to:', this.value);
            const option = this.options[this.selectedIndex];
            
            if (!option.value) {
                actorInputs.innerHTML = '<p class="text-gray-500 text-sm">Select an actor to see its input fields</p>';
                filterRules.classList.add('hidden');
                showScheduleForActor(null);
                return;
            }
            
            const schema = JSON.parse(option.dataset.schema || '[]');
            const filters = JSON.parse(option.dataset.filters || '{}');
            const actorKey = option.value;
            
            // Show appropriate schedule UI for this actor
            showScheduleForActor(actorKey);
            
            // Generate input fields
            actorInputs.innerHTML = '<h3 class="font-medium text-gray-700 mb-3">Actor Inputs</h3>' +
                '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' +
                schema.map(field => generateInputField(field, 'actor_')).join('') +
                '</div>';
            
            // Generate filter fields
            if (Object.keys(filters).length > 0) {
                filterRules.classList.remove('hidden');
                filterInputs.innerHTML = Object.entries(filters).map(([key, config]) => 
                    generateFilterField(key, config, 'filter_')
                ).join('');
            } else {
                filterRules.classList.add('hidden');
            }
        });
        
        console.log('‚úÖ Form handlers setup completed');
        }); // End DOMContentLoaded
        
        function generateInputField(field, prefix = '', value = '') {
            const id = `${prefix}${field.name}`;
            const required = field.required ? 'required' : '';
            const placeholder = field.placeholder || '';
            const help = field.help ? `<p class="text-xs text-gray-500 mt-1">${field.help}</p>` : '';
            const defaultVal = value || field.default || '';
            
            let input = '';
            
            switch (field.type) {
                case 'textarea':
                    input = `<textarea name="${id}" ${required} rows="3"
                              class="w-full border rounded-md px-3 py-2 text-sm"
                              placeholder="${placeholder}">${defaultVal}</textarea>`;
                    break;
                    
                case 'select':
                    const options = (field.options || []).map(opt => 
                        `<option value="${opt.value}" ${opt.value === defaultVal ? 'selected' : ''}>${opt.label}</option>`
                    ).join('');
                    input = `<select name="${id}" ${required} class="w-full border rounded-md px-3 py-2">
                              ${options}
                            </select>`;
                    break;
                    
                case 'boolean':
                    const checked = defaultVal ? 'checked' : '';
                    input = `<input type="checkbox" name="${id}" ${checked} class="h-4 w-4">`;
                    break;
                    
                case 'number':
                    input = `<input type="number" name="${id}" value="${defaultVal}" ${required}
                              class="w-full border rounded-md px-3 py-2">`;
                    break;
                    
                default:  // text, url
                    input = `<input type="${field.type === 'url' ? 'url' : 'text'}" name="${id}" 
                              value="${defaultVal}" ${required}
                              class="w-full border rounded-md px-3 py-2"
                              placeholder="${placeholder}">`;
            }
            
            return `<div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    ${field.label} ${field.required ? '*' : ''}
                </label>
                ${input}
                ${help}
            </div>`;
        }
        
        function generateFilterField(key, config, prefix = '', value = '') {
            let label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            let placeholder = '';
            
            if (config.type === 'exclude_contains') {
                placeholder = 'Comma-separated values to exclude';
            } else if (config.type === 'min_value') {
                label = 'Min ' + label.replace('Min ', '');
            } else if (config.type === 'max_value') {
                label = 'Max ' + label.replace('Max ', '');
            }
            
            const inputType = config.type.includes('value') ? 'number' : 'text';
            
            return `<div>
                <label class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                <input type="${inputType}" name="${prefix}${key}" value="${value || ''}"
                       class="w-full border rounded-md px-3 py-2 text-sm"
                       placeholder="${placeholder}">
            </div>`;
        }
        
        // =================================================================
        // FORM SUBMISSION (CREATE)
        // =================================================================
        
        document.getElementById('createForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const actorKey = formData.get('actor_key');
            const actorConfig = actorConfigs[actorKey];
            
            // Use unified time-based cron generation for all actors
            const cronSchedule = buildTimeBasedCron();
            
            // Build actor_inputs from dynamic fields
            const actorInputsData = {};
            const filterRulesData = {};
            
            for (const [key, value] of formData.entries()) {
                if (key.startsWith('actor_') && value) {
                    const fieldName = key.replace('actor_', '');
                    actorInputsData[fieldName] = value;
                } else if (key.startsWith('filter_') && value) {
                    const fieldName = key.replace('filter_', '');
                    filterRulesData[fieldName] = value;
                }
            }
            
            const payload = {
                name: formData.get('name'),
                actor_key: actorKey,
                cron_schedule: cronSchedule,
                actor_inputs: actorInputsData,
                filter_rules: filterRulesData,
                clay_webhook_url: formData.get('clay_webhook_url'),
                batch_size: parseInt(formData.get('batch_size')) || 8,
                batch_interval_ms: parseInt(formData.get('batch_interval_ms')) || 2000
            };
            
            try {
                this.classList.add('loading');
                
                const response = await fetch('/api/searches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create search');
                }
                
                location.reload();
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                this.classList.remove('loading');
            }
        });
        
        // =================================================================
        // EDIT FUNCTIONALITY
        // =================================================================
        
        async function editSearch(id) {
            console.log('editSearch called with id:', id);
            
            const modal = document.getElementById('editModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            try {
                const response = await fetch(`/api/searches/${id}`);
                const search = await response.json();
                
                // Populate basic fields
                document.getElementById('editId').value = search.id;
                document.getElementById('editName').value = search.name;
                document.getElementById('editClayWebhook').value = search.clay_webhook_url;
                
                // Parse and populate schedule from cron
                populateEditScheduleFromCron(search.cron_schedule);
                document.getElementById('editBatchSize').value = search.batch_size;
                document.getElementById('editBatchInterval').value = search.batch_interval_ms;
                document.getElementById('editIsActive').checked = search.is_active;
                document.getElementById('editActorKey').value = search.actor_key;
                document.getElementById('editActorDisplay').textContent = search.actor_display_name || search.actor_key;
                
                // Get actor config
                const actorConfig = actorConfigs[search.actor_key];
                
                if (actorConfig) {
                    // Generate actor input fields with current values
                    const inputFields = actorConfig.input_schema.map(field => {
                        const value = search.actor_inputs[field.name] || '';
                        return generateInputField(field, 'edit_actor_', value);
                    }).join('');
                    document.getElementById('editActorInputsFields').innerHTML = inputFields;
                    
                    // Generate filter fields with current values
                    const filterFields = Object.entries(actorConfig.filter_config).map(([key, config]) => {
                        const value = search.filter_rules[key] || '';
                        return generateFilterField(key, config, 'edit_filter_', value);
                    }).join('');
                    document.getElementById('editFilterInputs').innerHTML = filterFields;
                }
                
                // Setup edit modal schedule event listeners
                setupEditScheduleListeners();
                
            } catch (error) {
                alert('Error loading search: ' + error.message);
                closeEditModal();
            }
        }
        
        function closeEditModal() {
            const modal = document.getElementById('editModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('editId').value;
            const formData = new FormData(this);
            
            // Build actor_inputs and filter_rules from dynamic fields
            const actorInputsData = {};
            const filterRulesData = {};
            
            for (const [key, value] of formData.entries()) {
                if (key.startsWith('edit_actor_') && value) {
                    const fieldName = key.replace('edit_actor_', '');
                    actorInputsData[fieldName] = value;
                } else if (key.startsWith('edit_filter_') && value) {
                    const fieldName = key.replace('edit_filter_', '');
                    filterRulesData[fieldName] = value;
                }
            }
            
            const payload = {
                name: formData.get('name'),
                cron_schedule: formData.get('cron_schedule'),
                actor_inputs: actorInputsData,
                filter_rules: filterRulesData,
                clay_webhook_url: formData.get('clay_webhook_url'),
                batch_size: parseInt(formData.get('batch_size')) || 8,
                batch_interval_ms: parseInt(formData.get('batch_interval_ms')) || 2000,
                is_active: formData.get('is_active') === 'on'
            };
            
            try {
                this.classList.add('loading');
                
                const response = await fetch(`/api/searches/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to update search');
                }
                
                location.reload();
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                this.classList.remove('loading');
            }
        });
        
        // =================================================================
        // QUICK VIEW FUNCTIONALITY
        // =================================================================
        
        async function viewSearchDetails(id) {
            console.log('viewSearchDetails called with id:', id);
            
            const modal = document.getElementById('detailsModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            try {
                const response = await fetch(`/api/searches/${id}`);
                const search = await response.json();
                
                // Get actor config
                const actorConfig = actorConfigs[search.actor_key];
                
                // Populate basic info
                document.getElementById('detail-name').textContent = search.name;
                document.getElementById('detail-platform').textContent = search.actor_display_name || search.actor_key;
                document.getElementById('detail-schedule').textContent = search.cron_schedule;
                document.getElementById('detail-status').textContent = search.is_active ? 'Active' : 'Inactive';
                document.getElementById('detail-webhook').textContent = search.clay_webhook_url;
                document.getElementById('detail-batch-size').textContent = search.batch_size;
                document.getElementById('detail-batch-interval').textContent = search.batch_interval_ms;
                
                // Populate actor inputs
                const inputsContainer = document.getElementById('detail-inputs');
                inputsContainer.innerHTML = '';
                
                if (search.actor_inputs && Object.keys(search.actor_inputs).length > 0) {
                    Object.entries(search.actor_inputs).forEach(([key, value]) => {
                        const div = document.createElement('div');
                        div.innerHTML = `<span class="font-medium">${formatFieldName(key)}:</span> <span class="text-gray-700">${formatFieldValue(value)}</span>`;
                        inputsContainer.appendChild(div);
                    });
                } else {
                    inputsContainer.innerHTML = '<p class="text-gray-500">No input configuration</p>';
                }
                
                // Populate filter rules
                const filtersContainer = document.getElementById('detail-filters');
                filtersContainer.innerHTML = '';
                
                if (search.filter_rules && Object.keys(search.filter_rules).length > 0) {
                    Object.entries(search.filter_rules).forEach(([key, value]) => {
                        if (value) {
                            const div = document.createElement('div');
                            div.innerHTML = `<span class="font-medium">${formatFieldName(key)}:</span> <span class="text-gray-700">${formatFieldValue(value)}</span>`;
                            filtersContainer.appendChild(div);
                        }
                    });
                }
                
                if (filtersContainer.children.length === 0) {
                    filtersContainer.innerHTML = '<p class="text-gray-500">No filters applied</p>';
                }
                
            } catch (error) {
                console.error('Error loading search details:', error);
                document.getElementById('detailsContent').innerHTML = `
                    <div class="text-red-500 text-center p-4">
                        Error loading search details: ${error.message}
                    </div>
                `;
            }
        }
        
        function closeDetailsModal() {
            const modal = document.getElementById('detailsModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        function formatFieldName(fieldName) {
            return fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        function formatFieldValue(value) {
            if (Array.isArray(value)) {
                return value.join(', ');
            }
            if (typeof value === 'string' && value.length > 100) {
                return value.substring(0, 100) + '...';
            }
            return value;
        }
        
        // =================================================================
        // OTHER ACTIONS
        // =================================================================
        
        async function runSearch(id) {
            console.log('runSearch called with id:', id);
            
            if (!confirm('Run this search now?')) {
                console.log('User cancelled run');
                return;
            }
            
            console.log('Executing search...');
            
            try {
                const response = await fetch(`/api/searches/${id}/execute`, {
                    method: 'POST'
                });
                
                console.log('Response received:', response);
                
                const result = await response.json();
                
                console.log('Result:', result);
                
                if (result.success) {
                    alert(`Success! Found: ${result.jobs_found}, Filtered: ${result.jobs_filtered}, Sent: ${result.jobs_sent}`);
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error in runSearch:', error);
                alert('Error: ' + error.message);
            }
        }
        
        async function viewRuns(id) {
            console.log('viewRuns (History) called with id:', id);
            
            const modal = document.getElementById('historyModal');
            const content = document.getElementById('historyContent');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            content.innerHTML = 'Loading...';
            
            try {
                const response = await fetch(`/api/searches/${id}/runs?limit=20`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const runs = await response.json();
                console.log('Runs response:', runs, 'Type:', typeof runs, 'isArray:', Array.isArray(runs));
                
                if (!Array.isArray(runs)) {
                    throw new Error(`Expected array, got ${typeof runs}: ${JSON.stringify(runs)}`);
                }
                
                if (runs.length === 0) {
                    content.innerHTML = '<p class="text-gray-500">No runs yet</p>';
                    return;
                }
                
                content.innerHTML = `
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-sm">Started</th>
                                <th class="px-3 py-2 text-left text-sm">Status</th>
                                <th class="px-3 py-2 text-left text-sm">Found</th>
                                <th class="px-3 py-2 text-left text-sm">Filtered</th>
                                <th class="px-3 py-2 text-left text-sm">Sent</th>
                                <th class="px-3 py-2 text-left text-sm">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${runs.map(run => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 text-sm">${new Date(run.started_at).toLocaleString()}</td>
                                    <td class="px-3 py-2 text-sm status-${run.status}">${run.status}</td>
                                    <td class="px-3 py-2 text-sm">${run.jobs_found}</td>
                                    <td class="px-3 py-2 text-sm">${run.jobs_filtered}</td>
                                    <td class="px-3 py-2 text-sm">${run.jobs_sent}</td>
                                    <td class="px-3 py-2 text-sm">
                                        <div class="flex gap-2 flex-wrap">
                                            <button onclick="viewRunLogs(${run.id})" 
                                                    class="text-blue-600 hover:text-blue-800 text-xs font-medium">
                                                View Logs
                                            </button>
                                            ${run.apify_dataset_id ? `
                                                <button onclick="fetchDataset(${run.id})" 
                                                        class="text-green-600 hover:text-green-800 text-xs font-medium">
                                                    Fetch Dataset
                                                </button>
                                            ` : ''}
                                            ${(run.jobs_found > 0 && run.jobs_filtered >= 0) ? `
                                                <button onclick="pushToClay(${run.id})" 
                                                        class="text-purple-600 hover:text-purple-800 text-xs font-medium">
                                                    Push to Clay
                                                </button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                content.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }
        
        function closeModal() {
            const modal = document.getElementById('historyModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        async function viewRunLogs(runId) {
            const modal = document.getElementById('logsModal');
            const content = document.getElementById('logsContent');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            content.innerHTML = 'Loading logs...';
            
            try {
                const response = await fetch(`/api/runs/${runId}`);
                const runData = await response.json();
                
                if (runData.run.execution_logs) {
                    content.innerHTML = runData.run.execution_logs;
                } else if (runData.run.error_message) {
                    content.innerHTML = `‚ùå ERROR: ${runData.run.error_message}\n\nNo detailed logs available for this run.`;
                } else {
                    content.innerHTML = 'No logs available for this run.';
                }
                
                // Update modal title with run info
                const title = modal.querySelector('h3');
                title.textContent = `Execution Logs - Run #${runId} (${runData.run.status})`;
                
            } catch (error) {
                content.innerHTML = `Error loading logs: ${error.message}`;
            }
        }
        
        function closeLogsModal() {
            const modal = document.getElementById('logsModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        async function fetchDataset(runId) {
            if (!confirm('Fetch and process dataset data as fallback? This will overwrite any existing results for this run.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/runs/${runId}/fetch-dataset`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Dataset processing started!\n\nDataset ID: ${result.dataset_id}\n\nView progress in Apify Console: ${result.dataset_url}\n\nRefresh the page in a few minutes to see results.`);
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function pushToClay(runId) {
            if (!confirm('Push this run\'s data to Clay webhook manually? This will send jobs in batches according to the job search settings.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/runs/${runId}/push-to-clay`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`üöÄ Clay push started!\n\nJobs to send: ${result.jobs_to_send}\nBatch size: ${result.batch_size} jobs per batch\nInterval: ${result.batch_interval}\n\nThe jobs will be sent in the background. Refresh the page in a few minutes to see updated statistics.`);
                } else {
                    alert('‚ùå Error: ' + (result.message || result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function duplicateSearch(id) {
            try {
                const response = await fetch(`/api/searches/${id}/duplicate`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function deleteSearch(id, name) {
            if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
            
            try {
                const response = await fetch(`/api/searches/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        // Close modals on escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeEditModal();
                closeDetailsModal();
                closeLogsModal();
            }
        });
    </script>
</body>
</html>
